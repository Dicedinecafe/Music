<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice&Dine Music Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    
</head>
<body> 
    <header class="header">
     <a href="https://dicedinecafe.com" class="back-arrow" rel="noopener">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
    </svg>
</a>
            <div class="logo">
                <a href="https://dicedinecafe.com" rel="noopener">
     <svg width="240" height="34" viewBox="0 0 217 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M45.8651 2.34333C44.4119 0.895556 42.4027 0 40.1827 0H32.1461L24.1096 8C24.1096 5.79 23.2099 3.79 21.7556 2.34333C20.3023 0.895556 18.2932 0 16.0731 0H8.03653L0 8V24H16.0731L24.1096 16V24H40.1827L48.2192 16V8C48.2192 5.79 47.3195 3.79 45.8651 2.34333ZM12.0548 16C9.83582 16 8.03653 14.2089 8.03653 12C8.03653 9.79111 9.83582 8 12.0548 8C14.2738 8 16.0731 9.79111 16.0731 12C16.0731 14.2089 14.2738 16 12.0548 16ZM36.1644 16C33.9454 16 32.1461 14.2089 32.1461 12C32.1461 9.79111 33.9454 8 36.1644 8C38.3834 8 40.1827 9.79111 40.1827 12C40.1827 14.2089 38.3834 16 36.1644 16Z" fill="#00E6AA"/>
<path d="M74.9727 3.37054C73.8253 2.2961 72.4836 1.47054 70.95 0.892765C69.4153 0.316098 67.7399 0.0283203 65.9227 0.0283203H56.2744V23.9861H65.9908C67.7856 23.9861 69.451 23.6916 70.9846 23.1039C72.5194 22.5161 73.8532 21.6894 74.9895 20.6261C76.1258 19.5628 77.0064 18.2961 77.6326 16.8261C78.2566 15.355 78.5702 13.7494 78.5702 12.0072C78.5702 10.265 78.2566 8.63054 77.6326 7.17165C77.0075 5.71276 76.1202 4.4461 74.9727 3.37165V3.37054ZM72.1946 15.9094C71.6041 17.0183 70.7625 17.8605 69.672 18.4383C68.5803 19.015 67.3079 19.3039 65.8535 19.3039H61.6265V4.67721H65.8535C67.309 4.67721 68.5748 4.97165 69.6541 5.55943C70.7335 6.14721 71.5751 6.98499 72.1778 8.07165C72.7794 9.15721 73.0808 10.4583 73.0808 11.9739C73.0808 13.4894 72.785 14.8017 72.1946 15.9094Z" fill="#2D524A"/>
<path d="M83.6696 0.373535C82.8805 0.373535 82.2264 0.635757 81.7119 1.15909C81.1962 1.68242 80.9395 2.33798 80.9395 3.12353C80.9395 3.90909 81.1973 4.53798 81.7119 5.07242C82.2275 5.60687 82.8805 5.87465 83.6696 5.87465C84.4588 5.87465 85.1062 5.60687 85.6107 5.07242C86.1152 4.53798 86.3675 3.88798 86.3675 3.12353C86.3675 2.35909 86.1141 1.68242 85.6107 1.15909C85.1051 0.634646 84.4588 0.373535 83.6696 0.373535Z" fill="#2D524A"/>
<path d="M86.1717 8.06982H81.1377V23.9876H86.1717V8.06982Z" fill="#2D524A"/>
<path d="M99.3498 19.0909C98.8342 19.3197 98.2471 19.4342 97.5896 19.4342C96.8875 19.4342 96.2513 19.2709 95.6809 18.9431C95.1117 18.6153 94.6663 18.1686 94.3482 17.5997C94.0301 17.0331 93.8705 16.3764 93.8705 15.6342C93.8705 14.892 94.0301 14.242 94.3482 13.6864C94.6663 13.1297 95.105 12.6931 95.6653 12.3753C96.2245 12.0586 96.8663 11.8997 97.5896 11.8997C98.2247 11.8997 98.7906 11.9986 99.2829 12.1953C99.7773 12.392 100.209 12.6986 100.583 13.112L103.808 9.90308C102.996 9.05085 102.069 8.41197 101.027 7.98641C99.9861 7.56085 98.8398 7.34863 97.5896 7.34863C95.9232 7.34863 94.4197 7.70863 93.0814 8.42974C91.743 9.14974 90.6849 10.1375 89.9069 11.3931C89.1278 12.6497 88.7383 14.0731 88.7383 15.6675C88.7383 17.262 89.1222 18.6586 89.8902 19.9253C90.657 21.192 91.7107 22.1853 93.049 22.9053C94.3873 23.6253 95.8774 23.9864 97.5238 23.9864C98.8174 23.9864 99.9917 23.762 101.044 23.3153C102.098 22.8675 103.04 22.2075 103.874 21.3342L100.683 18.1242C100.309 18.5397 99.8655 18.8609 99.3498 19.0909Z" fill="#2D524A"/>
<path d="M119.011 8.36419C117.804 7.68752 116.411 7.34863 114.833 7.34863C113.255 7.34863 111.751 7.70863 110.456 8.42974C109.162 9.14974 108.137 10.1375 107.38 11.3931C106.624 12.6497 106.245 14.0731 106.245 15.6675C106.245 17.262 106.629 18.692 107.397 19.9586C108.164 21.2253 109.222 22.2131 110.571 22.922C111.921 23.6309 113.461 23.9864 115.195 23.9864C116.533 23.9864 117.762 23.7564 118.88 23.2986C119.999 22.8397 120.953 22.1531 121.742 21.2353L118.98 18.4853C118.496 19.032 117.937 19.4397 117.302 19.7131C116.666 19.9864 115.953 20.1231 115.163 20.1231C114.308 20.1231 113.567 19.9431 112.942 19.5831C112.317 19.2231 111.834 18.7109 111.495 18.0431C111.381 17.822 111.288 17.5842 111.213 17.3342L118.976 17.3153L122.665 17.3064C122.752 16.892 122.813 16.5264 122.846 16.2097C122.878 15.8931 122.895 15.5931 122.895 15.3086C122.895 13.7586 122.549 12.3831 121.859 11.182C121.169 9.98197 120.22 9.04308 119.013 8.36641L119.011 8.36419ZM111.213 13.8931C111.28 13.6631 111.362 13.4453 111.46 13.2442C111.778 12.5897 112.227 12.082 112.809 11.7209C113.39 11.3609 114.076 11.1809 114.865 11.1809C115.611 11.1809 116.242 11.3397 116.757 11.6564C117.272 11.9742 117.661 12.432 117.926 13.0331C118.036 13.2853 118.124 13.5664 118.192 13.8742L111.214 13.8942L111.213 13.8931Z" fill="#2D524A"/>
<path d="M132.844 7.93887C132.635 7.56554 132.531 7.13887 132.531 6.65554C132.531 6.08665 132.745 5.60887 133.175 5.22443C133.605 4.84109 134.149 4.64998 134.809 4.64998C135.469 4.64998 136.004 4.80332 136.478 5.11109C136.951 5.41776 137.407 5.86665 137.848 6.45887L141.219 3.26887C140.888 2.7211 140.414 2.19998 139.797 1.70665C139.181 1.21221 138.453 0.807762 137.617 0.489985C136.78 0.172207 135.822 0.012207 134.743 0.012207C133.356 0.012207 132.138 0.314429 131.092 0.916651C130.046 1.51887 129.22 2.31998 128.614 3.31776C128.008 4.31554 127.705 5.40554 127.705 6.58998C127.705 7.57665 127.893 8.48109 128.267 9.30221C128.466 9.73998 128.732 10.1911 129.062 10.6566C127.924 11.2911 127.044 12.0689 126.415 12.9866C125.645 14.1166 125.259 15.4044 125.259 16.85C125.259 18.1878 125.585 19.4 126.234 20.4844C126.883 21.57 127.798 22.4255 128.976 23.0511C130.153 23.6755 131.536 23.9878 133.121 23.9878C134.135 23.9878 135.087 23.8444 135.979 23.56C136.87 23.2744 137.663 22.9078 138.357 22.4578C138.661 22.2622 138.93 22.0622 139.172 21.8611L141.145 23.9844H147.059L133.747 9.18887C133.351 8.72776 133.049 8.3122 132.839 7.93887H132.844ZM135.191 18.9066C134.65 19.2255 134.006 19.3844 133.258 19.3844C132.598 19.3844 132.024 19.2633 131.541 19.0222C131.055 18.7811 130.687 18.4466 130.435 18.0189C130.18 17.5911 130.054 17.0933 130.054 16.5222C130.054 15.8211 130.219 15.2178 130.55 14.7133C130.82 14.3011 131.202 13.9566 131.694 13.6755L135.947 18.3278C135.716 18.5533 135.464 18.7466 135.192 18.9066H135.191Z" fill="#2D524A"/>
<path d="M168.144 3.36007C166.995 2.28562 165.654 1.45896 164.119 0.88118C162.584 0.304514 160.908 0.015625 159.088 0.015625H149.436V23.9867H159.158C160.952 23.9867 162.619 23.6923 164.154 23.1045C165.689 22.5167 167.023 21.689 168.161 20.6256C169.298 19.5612 170.179 18.2934 170.805 16.8223C171.43 15.3512 171.742 13.7445 171.742 12.0012C171.742 10.2578 171.43 8.6234 170.805 7.1634C170.18 5.7034 169.292 4.43673 168.145 3.36118L168.144 3.36007ZM165.365 15.9056C164.773 17.0156 163.931 17.8578 162.84 18.4356C161.748 19.0123 160.475 19.3012 159.02 19.3012H154.791V4.66785H159.02C160.476 4.66785 161.743 4.96229 162.823 5.55007C163.902 6.13896 164.744 6.97673 165.348 8.0634C165.949 9.15007 166.251 10.4523 166.251 11.9678C166.251 13.4834 165.955 14.7967 165.365 15.9056Z" fill="#2D524A"/>
<path d="M215.949 11.1812C215.259 9.98121 214.31 9.04232 213.104 8.36565C211.897 7.68899 210.504 7.3501 208.925 7.3501C207.345 7.3501 205.843 7.7101 204.549 8.43121C203.254 9.15121 202.229 10.139 201.473 11.3945C200.716 12.6512 200.338 14.0745 200.338 15.669C200.338 17.2634 200.722 18.6934 201.49 19.9601C202.257 21.2268 203.315 22.2145 204.664 22.9234C206.014 23.6323 207.554 23.9879 209.287 23.9879C210.626 23.9879 211.855 23.7579 212.973 23.3001C214.092 22.8412 215.046 22.1545 215.835 21.2368L213.072 18.4868C212.589 19.0334 212.03 19.4412 211.395 19.7145C210.759 19.9879 210.045 20.1245 209.256 20.1245C208.4 20.1245 207.659 19.9445 207.035 19.5845C206.41 19.2245 205.927 18.7123 205.586 18.0445C205.473 17.8234 205.381 17.5857 205.306 17.3357L213.069 17.3168L216.757 17.3079C216.845 16.8934 216.905 16.5279 216.939 16.2112C216.971 15.8945 216.988 15.5945 216.988 15.3101C216.988 13.7601 216.642 12.3845 215.951 11.1834L215.949 11.1812ZM205.305 13.8934C205.373 13.6634 205.454 13.4457 205.553 13.2445C205.871 12.5901 206.32 12.0823 206.902 11.7212C207.483 11.3612 208.169 11.1812 208.958 11.1812C209.703 11.1812 210.334 11.3401 210.85 11.6568C211.366 11.9745 211.754 12.4323 212.018 13.0334C212.128 13.2857 212.216 13.5668 212.284 13.8745L205.306 13.8945L205.305 13.8934Z" fill="#2D524A"/>
<path d="M176.843 0.373535C176.054 0.373535 175.4 0.635757 174.886 1.15909C174.37 1.68242 174.113 2.33798 174.113 3.12353C174.113 3.90909 174.371 4.53798 174.886 5.07242C175.4 5.60687 176.054 5.87465 176.843 5.87465C177.633 5.87465 178.28 5.60687 178.785 5.07242C179.289 4.53798 179.541 3.88798 179.541 3.12353C179.541 2.35909 179.288 1.68242 178.785 1.15909C178.279 0.634646 177.633 0.373535 176.843 0.373535Z" fill="#2D524A"/>
<path d="M179.344 8.06982H174.31V23.9876H179.344V8.06982Z" fill="#2D524A"/>
<path d="M189.94 7.74219C185.506 7.74219 181.912 11.3211 181.912 15.7333V23.9866H186.929V15.7333C186.929 14.0811 188.281 12.7366 189.94 12.7366C191.598 12.7366 192.95 14.0811 192.95 15.7333V23.9866H197.967V15.7333C197.967 11.32 194.373 7.74219 189.94 7.74219Z" fill="#2D524A"/>
</svg>

</a>   
    </header>
  </div>
    <!-- Cooldown Modal -->
    <div class="modal-overlay" id="cooldownModal">
        <div class="modal">
            <h3>Please Wait</h3>
            <p id="cooldownMessage">Please wait <span id="cooldownTime">10</span> minutes before adding another song.</p>
            <button class="modal-close" onclick="closeCooldownModal()">OK</button>
        </div>
    </div>

   
            
       

        <div class="search-bar">
            <div class="search-icon">
                <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24.4064 26L14.9078 16.5012C14.1516 17.1255 13.282 17.6141 12.299 17.967C11.316 18.3199 10.2991 18.4963 9.24828 18.4963C6.66346 18.4963 4.47587 17.6014 2.68552 15.8116C0.895174 14.0218 0 11.8347 0 9.25042C0 6.66639 0.894922 4.47858 2.68477 2.687C4.47461 0.895665 6.66169 0 9.24602 0C11.8301 0 14.0179 0.89516 15.8095 2.68548C17.6009 4.4758 18.4966 6.66336 18.4966 9.24815C18.4966 10.3282 18.3153 11.3597 17.9529 12.3427C17.5902 13.3257 17.1064 14.1807 16.5014 14.9076L26 24.406L24.4064 26ZM9.24828 16.2282C11.1969 16.2282 12.8474 15.552 14.1997 14.1994C15.5522 12.8472 16.2284 11.1968 16.2284 9.24815C16.2284 7.29954 15.5522 5.6491 14.1997 4.29685C12.8474 2.94434 11.1969 2.26809 9.24828 2.26809C7.29964 2.26809 5.64919 2.94434 4.29691 4.29685C2.94438 5.6491 2.26812 7.29954 2.26812 9.24815C2.26812 11.1968 2.94438 12.8472 4.29691 14.1994C5.64919 15.552 7.29964 16.2282 9.24828 16.2282Z" fill="#B3B3B3"/>
                </svg>
            </div>
            <input type="text" class="search-input" id="search-input" placeholder="What do you want to play?">
        </div>

        <div class="main-content">
            <div class="now-playing">
               <div class="playing-now">Now Playing</div>
                <div class="now-playing-content">
           
                    <div class="album-art">
                        <img id="now-image" src="https://via.placeholder.com/200" alt="Album Art">
                    </div>
                    <div class="track-info">
                        <div>
                            <h1 id="now-title">Nothing Playing</h1>
                            <div class="artist" id="now-artist">-</div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="now-progress">
                                    <div class="progress-handle"></div>
                                </div>
                            </div>
                            <div class="time-info">
                                <span id="now-current">0:00</span>
                                <span id="now-duration">0:00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="up-next">
                <h2>Up Next</h2>
                <div id="next-container">
                    <div class="next-track">
                        <img src="https://via.placeholder.com/60" alt="Next Track">
                        <div class="next-track-info">
                            <h3>Queue is empty</h3>
                            <p>-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="results" id="results">
           
        </div>
    </div>

    <script>
        // Cooldown system
       let lastAddTime = Number(localStorage.getItem('lastAddTime')) || 0;
const COOLDOWN_MINUTES = 10;

function getCooldownRemaining() {
    const elapsed = Date.now() - lastAddTime;
    const remaining = (COOLDOWN_MINUTES * 60 * 1000) - elapsed;
    return remaining > 0 ? remaining : 0;
}

function showCooldownModal() {
    const remaining = getCooldownRemaining();
    const minutes = Math.floor(remaining / (60 * 1000));
    const seconds = Math.ceil((remaining % (60 * 1000)) / 1000);

    let timeString = '';
    if (minutes > 0) {
        timeString = `${minutes}m ${seconds}s`;
    } else {
        timeString = `${seconds}s`;
    }

    document.getElementById('cooldownTime').textContent = timeString;
    document.getElementById('cooldownModal').classList.add('active');
}

function closeCooldownModal() {
    document.getElementById('cooldownModal').classList.remove('active');
}

function canAddSong() {
    return getCooldownRemaining() === 0;
}
        // SEARCH FUNCTIONALITY
        const searchInput = document.getElementById('search-input');
        const resultsDiv = document.getElementById('results');

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        searchInput.addEventListener('input', (e) => {
            if (e.target.value.trim() === '') {
                // Show main content when search is empty
                document.querySelector('.main-content').classList.remove('hidden');
                resultsDiv.innerHTML = '';
            }
        });

        function performSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                // Show main content when search is empty
                document.querySelector('.main-content').classList.remove('hidden');
                resultsDiv.innerHTML = '';
                return;
            }

            // Hide main content when searching
            document.querySelector('.main-content').classList.add('hidden');
            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';

            fetch(`/search?q=${encodeURIComponent(query)}&limit=50`)
                .then(res => res.json())
                .then(tracks => {
                    if (!tracks.length) {
                        resultsDiv.innerHTML = '<div class="empty-state">No results found</div>';
                        return;
                    }

                    resultsDiv.innerHTML = tracks.map(track => `
                        <div class="track">
                            <img src="${track.image || 'https://via.placeholder.com/80'}" alt="${track.name}" class="track-image">
                            <div class="track-info">
                                <h3>${track.name}</h3>
                                <p>${track.artist}</p>
                            </div>
                            <button class="queue-btn" data-uri="${track.uri}">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    resultsDiv.innerHTML = '<div class="empty-state">Search failed. Please try again.</div>';
                    console.error('Search error:', err);
                });
        }

        resultsDiv.addEventListener('click', (e) => {
            if (e.target.closest('.queue-btn')) {
                const button = e.target.closest('.queue-btn');
                const uri = button.getAttribute('data-uri');
                
                if (!canAddSong()) {
                    showCooldownModal();
                    return;
                }
                
                queueTrack(uri, button);
            }
        });

      async function queueTrack(uri, button) {
    const original = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;

    try {
        const res = await fetch('/queue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uri })
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Queue failed');

        // Set cooldown and persist it
        lastAddTime = Date.now();
        localStorage.setItem('lastAddTime', lastAddTime);

        button.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            button.innerHTML = original;
            button.disabled = false;
        }, 2000);
    } catch (err) {
        alert(err.message);
        button.innerHTML = original;
        button.disabled = false;
    }
}
        let lastProgress = 0;
let lastDuration = 0;
let lastUpdateTime = Date.now();
let isPlaying = false;

function updateProgressBarSmooth() {
    if (!isPlaying) return;
    const now = Date.now();
    const elapsed = now - lastUpdateTime;
    let currentProgress = lastProgress + elapsed;
    if (currentProgress > lastDuration) currentProgress = lastDuration;

    const bar = document.getElementById('now-progress');
    const currentTime = document.getElementById('now-current');
    const durationTime = document.getElementById('now-duration');

    bar.style.width = `${(currentProgress / lastDuration) * 100}%`;

    const format = ms => {
        const mins = Math.floor(ms / 60000);
        const secs = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    };

    currentTime.textContent = format(currentProgress);
    durationTime.textContent = format(lastDuration);
}

setInterval(updateProgressBarSmooth, 1000);
// NOW PLAYING FROM /current
       function fetchNowPlaying() {
    fetch('/current')
        .then(res => res.json())
        .then(data => {
            const title = document.getElementById('now-title');
            const artist = document.getElementById('now-artist');
            const image = document.getElementById('now-image');
            const bar = document.getElementById('now-progress');
            const currentTime = document.getElementById('now-current');
            const durationTime = document.getElementById('now-duration');

            if (!data || data.message || !data.name) {
                title.textContent = 'Nothing Playing';
                artist.textContent = '-';
                image.src = 'https://via.placeholder.com/200';
                bar.style.width = '0%';
                currentTime.textContent = '0:00';
                durationTime.textContent = '0:00';
                isPlaying = false;
                return;
            }

            title.textContent = data.name;
            artist.textContent = data.artist;
            image.src = data.image || 'https://via.placeholder.com/200';

            lastProgress = data.progress_ms;
            lastDuration = data.duration_ms;
            lastUpdateTime = Date.now();
            isPlaying = true;

            bar.style.width = `${(lastProgress / lastDuration) * 100}%`;

            const format = ms => {
                const mins = Math.floor(ms / 60000);
                const secs = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
                return `${mins}:${secs}`;
            };

            currentTime.textContent = format(lastProgress);
            durationTime.textContent = format(lastDuration);
        })
        .catch(err => {
            console.error('Now playing error:', err);
        });
}

        // UP NEXT FROM /queue-spotify
        async function loadQueue() {
            try {
                const response = await fetch('/queue-spotify');
                if (!response.ok) throw new Error("Failed to fetch queue");
                const data = await response.json();

                const container = document.getElementById('next-container');

                if (data.queue && data.queue.length > 0) {
                    // Show up to 10 songs in queue
                    const queueToShow = data.queue.slice(0, 10);
                    container.innerHTML = queueToShow.map(track => `
                        <div class="next-track">
                            <img src="${track.image || 'https://via.placeholder.com/60'}" alt="${track.name}">
                            <div class="next-track-info">
                                <h3>${track.name}</h3>
                                <p>${track.artist}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="next-track">
                            <img src="https://via.placeholder.com/60" alt="Next Track">
                            <div class="next-track-info">
                                <h3>Queue is empty</h3>
                                <p>-</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("Queue load error:", error);
                document.getElementById('next-container').innerHTML = `
                    <div class="next-track">
                        <img src="https://via.placeholder.com/60" alt="Next Track">
                        <div class="next-track-info">
                            <h3>Failed to load queue</h3>
                            <p>-</p>
                        </div>
                    </div>
                `;
            }
        }

        // Back button functionality
        document.querySelector('.back-btn').addEventListener('click', function() {
            console.log('Navigate back');
        });

        // Close modal when clicking outside
        document.getElementById('cooldownModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCooldownModal();
            }
        });

        // INIT
        setInterval(fetchNowPlaying, 5000);
        fetchNowPlaying();
        setInterval(loadQueue, 5000);
        loadQueue();
    </script>
</body>
</html>
